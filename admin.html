<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel - Dharini Flower Jewellery</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-pink-50 font-poppins">

<!-- LOGIN -->
<div id="loginDiv" class="container mx-auto p-6 max-w-md mt-20 bg-white rounded-xl shadow-md">
  <h3 class="text-2xl font-bold text-pink-800 mb-4 text-center">Admin Login</h3>
  <input id="adminID" type="text" placeholder="Enter Admin ID" class="w-full border rounded-lg px-3 py-2 mb-3">
  <input id="adminPass" type="password" placeholder="Enter Password" class="w-full border rounded-lg px-3 py-2 mb-3">
  <button onclick="checkLogin()" class="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 w-full">Login</button>
</div>

<!-- ADMIN PANEL -->
<div id="panelDiv" class="container mx-auto p-6 hidden">
  <h3 class="text-2xl font-bold text-pink-800 mb-4">Admin Panel</h3>

  <!-- ADD PRODUCT -->
  <input id="productName" type="text" placeholder="Product Name" class="w-full border rounded-lg px-3 py-2 mb-3">
  <textarea id="productDesc" placeholder="Product Description" class="w-full border rounded-lg px-3 py-2 mb-3"></textarea>
  <input id="productPrice" type="text" placeholder="Price" class="w-full border rounded-lg px-3 py-2 mb-3">
  <input id="productImage" type="file" accept="image/*" class="w-full border rounded-lg px-3 py-2 mb-3">
  <button onclick="addProduct()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 mb-6">Add Product</button>

  <!-- PRODUCT LIST -->
  <h4 class="text-xl font-bold text-pink-800 mb-3">Existing Products</h4>
  <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
</div>

<script>
  // FIREBASE CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyARKrfUDH1sJr5rIrx5VSpTA0mdigSUDew",
    authDomain: "dharini-flower-jewellery.firebaseapp.com",
    projectId: "dharini-flower-jewellery",
    storageBucket: "dharini-flower-jewellery.appspot.com",
    messagingSenderId: "953232943869",
    appId: "1:953232943869:web:04b04ccbcbe3b0e759ac94"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // CLOUDINARY CONFIG
  const CLOUD_NAME = "dyqf1xo36";
  const UPLOAD_PRESET = "dharini-flower-jewellery";

  // Admin credentials
  const ADMIN_ID = "dhariniAdmin";
  const ADMIN_PASS = "flower123";

  function checkLogin() {
    const id = document.getElementById("adminID").value;
    const pass = document.getElementById("adminPass").value;
    if(id === ADMIN_ID && pass === ADMIN_PASS){
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("panelDiv").classList.remove("hidden");
      loadProducts();
    } else {
      alert("Incorrect ID or Password!");
    }
  }

  async function addProduct() {
    const name = document.getElementById("productName").value;
    const desc = document.getElementById("productDesc").value;
    const price = document.getElementById("productPrice").value;
    const file = document.getElementById("productImage").files[0];

    if(!file) return alert("Please select an image.");

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", UPLOAD_PRESET);

    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    db.collection("products").add({
      name, desc, price, img: data.secure_url
    }).then(() => {
      alert("Product added successfully!");
      clearForm();
    }).catch(err => {
      console.error(err);
      alert("Error adding product.");
    });
  }

  function clearForm() {
    document.getElementById("productName").value = "";
    document.getElementById("productDesc").value = "";
    document.getElementById("productPrice").value = "";
    document.getElementById("productImage").value = "";
  }

  function loadProducts() {
    const productList = document.getElementById("productList");
    db.collection("products").onSnapshot(snapshot => {
      productList.innerHTML = "";
      snapshot.forEach(doc => {
        const p = doc.data();
        const id = doc.id;

        const card = document.createElement("div");
        card.className = "bg-white p-3 rounded-lg shadow-md";

        card.innerHTML = `
          <img src="${p.img}" class="w-full h-40 object-cover rounded mb-2">
          <h4 class="text-lg font-bold text-pink-700">${p.name}</h4>
          <p class="text-gray-600 mb-1">${p.desc}</p>
          <p class="font-semibold text-pink-900 mb-2">${p.price}</p>
          <button onclick="editProduct('${id}')" class="bg-yellow-500 text-white px-3 py-1 rounded mr-2 hover:bg-yellow-600">Edit</button>
          <button onclick="deleteProduct('${id}')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Delete</button>
        `;

        productList.appendChild(card);
      });
    });
  }

  function deleteProduct(id) {
    if(confirm("Are you sure you want to delete this product?")) {
      db.collection("products").doc(id).delete().then(() => {
        alert("Product deleted!");
      }).catch(err => console.error(err));
    }
  }

  async function editProduct(id) {
    const docRef = db.collection("products").doc(id);
    const docSnap = await docRef.get();
    if(!docSnap.exists) return alert("Product not found!");

    const p = docSnap.data();
    const newName = prompt("Edit Name:", p.name);
    const newDesc = prompt("Edit Description:", p.desc);
    const newPrice = prompt("Edit Price:", p.price);

    let newImg = p.img;
    const changeImg = confirm("Do you want to change the image?");
    if(changeImg) {
      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.click();
      fileInput.onchange = async () => {
        const file = fileInput.files[0];
        if(!file) return;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", UPLOAD_PRESET);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        newImg = data.secure_url;
        docRef.update({ name: newName, desc: newDesc, price: newPrice, img: newImg });
        alert("Product updated!");
      };
      return;
    }

    docRef.update({ name: newName, desc: newDesc, price: newPrice, img: newImg }).then(() => {
      alert("Product updated!");
    }).catch(err => console.error(err));
  }
</script>
</body>
</html>
